/*

  send-with-template.protected.js

  Used to send email via sendgrid api

*/

const sgMail = require('@sendgrid/mail')

exports.handler = function (context, event, callback) {

  console.log("event in post is ==> ", event);
  
  sgMail.setApiKey(context.SENDGRID_API_KEY);

  let fieldNames = event.fieldNames.split('|');
  let fieldValues = event.fieldValues.split('|');  
  let bodyHtml = "<p>A simple service message generated by a Twilio Demo! Your instructions would go here!</p><ul>";
  for(let i=0;i<fieldNames.length;i++) {
    bodyHtml += `<li>${fieldNames[i]}: ${fieldValues[i]}</li>`;
  }
  bodyHtml += "</ul><p><strong>www.twilio.com</strong></p>";

  console.log("bodyHtml => ", bodyHtml);

  const msg = {
    to: event.TO_EMAIL,
    from: context.SENDGRID_VERIFIED_SENDER,
    subject: 'DEMO EMAIL! Flex Support Department',
    text: "We cant wait to see what you build.",
    html: bodyHtml
  };

  console.log("msg => ", msg);
    
  sgMail
  .send(msg)
  .then(() => {
    console.log('Email sent');
    callback(null, "Email Sent!");
  })
  .catch((error) => {
    console.error(error);
    callback(null, "Email NOT Sent!");
  });    

};